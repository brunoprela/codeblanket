export const smartOrderRoutingQuiz = [
    {
        id: 'smart-order-routing-q-1',
        question:
            'Design a "venue scoring algorithm" for smart order routing that optimizes across multiple dimensions. Include: (1) Price factor (NBBO compliance, price improvement), (2) Liquidity factor (order book depth, available size), (3) Fee optimization (maker/taker fees, rebates), (4) Latency factor (venue ack time), (5) Fill probability (historical fill rates), (6) Weighted scoring formula and decision tree for venue selection.',
        sampleAnswer:
            'Venue Scoring Algorithm Design: **Scoring Formula**: Total Score = (Price × W_price) + (Liquidity × W_liq) - (Latency × W_lat) + (Fees × W_fee) + (FillRate × W_fill). Weights: W_price = 1000 (most important), W_liq = 100, W_lat = 10, W_fee = 100, W_fill = 50. **Price Factor** (most critical, Reg NMS requirement): At NBBO = 1.0 (full points), away from NBBO = 0.0 (exclude for market orders), price improvement = (improvement_bps × 10). Example: NBBO ask $150.01, Venue ask $150.00 → improvement = 1 cent = 6.7 bps → score += 67. Price factor score: At NBBO: 1.0 × 1000 = 1000 points. Not at NBBO (market order): 0 points (Reg NMS violation). Limit order away: Acceptable if within limit price. **Liquidity Factor**: Formula: liquidity_score = min(available_size / order_quantity, 1.0). Example: Order 5,000 shares, Venue A: 10,000 available → score = 1.0 (sufficient), Venue B: 2,500 available → score = 0.5 (partial). Liquidity score: Venue A: 1.0 × 100 = 100 points, Venue B: 0.5 × 100 = 50 points. Importance: Prefer venues that can fill entire order (avoid routing to 10 venues). **Fee Optimization**: Maker fee (limit orders): Negative = rebate (good), NYSE: -$0.0015/share → +$0.15 per 100 shares, NASDAQ: -$0.0013/share → +$0.13 per 100 shares. Taker fee (market orders): Positive = fee (bad), Most venues: +$0.0030/share → -$0.30 per 100 shares. Fee score: Rebate case (limit order, NYSE): -(-$0.0015) × 5000 × 100 = +750 points, Fee case (market order, NYSE): -($0.0030) × 5000 × 100 = -1500 points. Strategy: Limit orders → prefer high rebate venues (BATS $0.0020), Market orders → minimize taker fees (IEX $0.0009). **Latency Factor**: Measure venue acknowledgement time: NASDAQ: 1.5ms (best), NYSE: 2.0ms, BATS: 2.5ms, IEX: 3.0ms (speed bump). Latency score (lower is better, negative weight): NASDAQ: -1.5 × 10 = -15 points, IEX: -3.0 × 10 = -30 points. Importance: For high-frequency: latency critical, For institutional: latency less important than price/fees. **Fill Probability**: Historical fill rates by venue (last 30 days): NYSE: 98% fill rate, NASDAQ: 97%, BATS: 96%, Dark pools: 30% (expected). Fill score: NYSE: 0.98 × 50 = 49 points, Dark pool: 0.30 × 50 = 15 points. Importance: Venue with deep liquidity but poor fills → lower score, Balance size vs execution certainty. **Complete Example** (Buy 5,000 AAPL): Venue A (NYSE): Price: At NBBO ($150.01) = 1000 pts, Liquidity: 5,000/5,000 = 1.0 → 100 pts, Latency: 2.0ms → -20 pts, Fees: Market taker $0.003 × 5000 = -$15 → -1500 pts, Fill rate: 98% → 49 pts, Total: 1000+100-20-1500+49 = -371 pts. Venue B (NASDAQ): Price: 1000, Liquidity: 100, Latency: -15, Fees: -1500, Fill: 48.5, Total: -366.5 pts (best!). Venue C (BATS): Price: 0 (not at NBBO), excluded. Winner: NASDAQ (highest score = -366.5). **Decision Tree**: Q1: Is order market or limit? Market → Must route to NBBO (exclude non-NBBO venues). Limit → Can route to any venue. Q2: Is order >10,000 shares? Yes → Use dark pools (30% allocation). No → Lit venues only. Q3: Order type specific: Market → Minimize taker fees, choose low latency. Limit → Maximize maker rebates, liquidity less critical. Q4: Urgency? High → Prioritize latency (NASDAQ). Normal → Prioritize fees/rebates. **Implementation**: def score_venue(venue, quote, nbbo, side, order_type, quantity): score = 0, # Price, if side == "BUY": is_nbbo = (quote.ask == nbbo.best_ask), else: is_nbbo = (quote.bid == nbbo.best_bid), score += 1000 if is_nbbo else 0, # Liquidity, available = quote.ask_size if side=="BUY" else quote.bid_size, liq_score = min(available / quantity, 1.0), score += liq_score × 100, # Latency, score -= venue.latency_ms × 10, # Fees, fee = venue.taker_fee if order_type=="MARKET" else venue.maker_fee, score -= fee × quantity × 100, # Fill rate, score += venue.fill_rate × 50, return score. **Advanced Considerations**: Time-weighted scoring: Recent performance weighted higher (last week 50%, last month 30%, older 20%). Venue bans: If venue reject rate >5% → temporarily exclude (circuit breaker). Adaptive weights: Adjust weights based on market conditions (volatile → prioritize certainty, calm → prioritize fees).',
        keyPoints: [
            'Scoring formula: (Price×1000) + (Liq×100) - (Latency×10) + (Fees×100) + (FillRate×50); price is dominant factor',
            'Price factor: At NBBO = 1000 pts, away from NBBO = 0 (exclude for market orders); price improvement = bps × 10',
            'Liquidity: min(available/order_qty, 1.0); prefer venues that can fill entire order to minimize routing complexity',
            'Fees: Maker rebates are positive (limit orders prefer high rebates), taker fees negative (market orders minimize fees)',
            'Decision tree: Market orders must use NBBO venues; large orders (>10K) use dark pools; urgent orders prioritize latency',
        ],
    },
    {
        id: 'smart-order-routing-q-2',
        question:
            'Implement an "order splitting strategy" for a 100,000 share order that must be routed across multiple venues. Include: (1) NBBO liquidity aggregation (total available at best price), (2) Proportional allocation (based on venue liquidity), (3) Handling insufficient liquidity (routing to next price level or dark pools), (4) Venue limits (don\'t exceed 20% of venue\'s displayed size), (5) Tracking fills from multiple venues, (6) Calculate expected execution price and slippage.',
        sampleAnswer:
            'Order Splitting Strategy for 100K Shares: **NBBO Liquidity Aggregation**: Query all venues for NBBO (best bid/ask): NBBO ask (buying): $150.01, Venues at NBBO: NYSE: 30,000 shares, NASDAQ: 25,000 shares, BATS: 15,000 shares, IEX: 10,000 shares. Total available at NBBO: 80,000 shares. Order: 100,000 shares. Gap: 20,000 shares (insufficient at NBBO). **Proportional Allocation Strategy**: Allocate 80,000 shares proportionally to venue liquidity: NYSE: 30K / 80K = 37.5% → 37.5% × 80K = 30,000 shares, NASDAQ: 25K / 80K = 31.25% → 25,000 shares, BATS: 15K / 80K = 18.75% → 15,000 shares, IEX: 10K / 80K = 12.5% → 10,000 shares. Total routed to lit venues: 80,000 shares at $150.01. **Handling Insufficient Liquidity** (20,000 share gap): Option 1: Wait for NBBO to replenish (passive strategy). Risk: Price moves away, miss opportunity. Option 2: Route to next price level ($150.02): Query liquidity at $150.02: ARCA: 15,000, EDGX: 10,000. Route 20,000 to next level (split proportionally). Average price: (80,000 × $150.01 + 20,000 × $150.02) / 100,000 = $150.012. Slippage: $150.012 - $150.01 (NBBO) = 0.2 cents = 1.3 bps. Option 3: Route to dark pools (preferred for large orders): Send 20,000 to dark pools (Liquidnet, POSIT): Expected fill rate: 30-40% (6,000-8,000 shares). Expected price: Midpoint $150.005 (better than NBBO!). Remaining: Route to lit venues at next level. Hybrid approach (recommended): 80K lit venues (NBBO), 20K dark pools (first attempt), if dark pools fill <50%: route unfilled to next level. **Venue Limits (20% Rule)**: Problem: Large orders can move market if we dominate venue. Limit: Don\'t exceed 20% of venue\'s displayed liquidity. Example: NYSE displays 30K shares, we want to route 30K (100%). Limit: 30K × 20% = 6,000 shares max. Capped allocation: NYSE: min(30,000, 30,000 × 20%) = 6,000 shares, NASDAQ: 5,000 shares (capped), BATS: 3,000 shares, IEX: 2,000 shares. Total with cap: 16,000 shares (insufficient!). Solution: Spread across more venues or use algo execution (VWAP over time). **Fill Tracking from Multiple Venues**: Send orders: NYSE: 30K shares at $150.01 LIMIT, NASDAQ: 25K at $150.01, BATS: 15K at $150.01, IEX: 10K at $150.01. Receive fills asynchronously: T+0ms: NYSE fill 20K @ $150.01, T+50ms: NASDAQ fill 25K @ $150.01, T+100ms: BATS fill 15K @ $150.01, T+150ms: NYSE fill 10K @ $150.01 (remaining), T+200ms: IEX fill 10K @ $150.01. Track cumulative: After NYSE: 20K filled, avg $150.01, After NASDAQ: 45K filled, avg $150.01, After BATS: 60K filled, avg $150.01, After NYSE #2: 70K filled, avg $150.01, After IEX: 80K filled, avg $150.01. Remaining: 20K unfilled (route to dark pools or next level). **Expected Execution Price Calculation**: Scenario 1 (NBBO only): 80K @ $150.01, 20K unfilled. Avg: $150.01 for filled portion. Scenario 2 (NBBO + Next Level): 80K @ $150.01, 20K @ $150.02. Weighted avg: (80K×$150.01 + 20K×$150.02) / 100K = $150.012. Scenario 3 (NBBO + Dark Pool midpoint): 80K @ $150.01, 20K @ $150.005 (midpoint). Weighted avg: (80K×$150.01 + 20K×$150.005) / 100K = $150.009. Best: Dark pool scenario (saves 0.3 cents vs next level). **Slippage Calculation**: Benchmark: NBBO at order time = $150.01. Actual execution: $150.012 (Scenario 2). Slippage: $150.012 - $150.01 = 0.2 cents. Slippage bps: 0.002 / 150.01 × 10000 = 1.33 bps. Total cost: 100K × $0.002 = $200 slippage. Compare to: Fees: 100K × $0.003 taker = $300. Rebates: 0 (market orders don\'t earn). Total: $500 cost. As percentage: $500 / ($150.01 × 100,000) = 0.033% = 3.3 bps. **Implementation**: def split_order(symbol, side, quantity, nbbo, quotes): # Aggregate NBBO liquidity, nbbo_venues = {}, total_liq = 0, for venue, quote in quotes.items(): if is_at_nbbo(quote, nbbo, side): liq = get_available(quote, side), nbbo_venues[venue] = liq, total_liq += liq, # Check sufficiency, if total_liq >= quantity: # Sufficient, allocate proportionally, splits = {}, for venue, liq in nbbo_venues.items(): proportion = liq / total_liq, splits[venue] = int(quantity × proportion), else: # Insufficient, splits = nbbo_venues.copy(), # Route remaining to dark pools or next level, remaining = quantity - total_liq, dark_pool_splits = route_to_dark_pools(remaining), splits.update(dark_pool_splits), return splits.',
        keyPoints: [
            'NBBO aggregation: Total 80K shares available at $150.01 across NYSE/NASDAQ/BATS/IEX; order 100K → 20K gap',
            'Proportional allocation: NYSE 37.5% (30K/80K), NASDAQ 31.25%, BATS 18.75%, IEX 12.5%; distribute based on liquidity',
            'Insufficient liquidity: Route gap to dark pools (midpoint $150.005) or next level ($150.02); hybrid approach best',
            'Venue limits: Cap at 20% of displayed size to avoid market impact; may need algo execution (VWAP) if caps too restrictive',
            'Slippage: $150.012 avg vs $150.01 NBBO = 0.2 cents = 1.33 bps; total cost including fees = 3.3 bps',
        ],
    },
    {
        id: 'smart-order-routing-q-3',
        question:
            'Design a "dark pool routing strategy" that balances stealth execution with fill probability. Include: (1) Order size threshold (when to use dark pools), (2) Dark pool allocation percentage (how much of order), (3) Dark pool selection criteria (fill rates, price improvement), (4) Timeout strategy (how long to wait for dark pool fills), (5) Fallback to lit venues (when to give up on dark pools), (6) Performance measurement (dark pool vs lit execution comparison).',
        sampleAnswer:
            'Dark Pool Routing Strategy: **Order Size Threshold**: Rule: Use dark pools for orders >10,000 shares. Rationale: Small orders (<10K): Execute on lit venues (fast, certain fill). Medium orders (10-50K): 30% dark pool, 70% lit. Large orders (>50K): 50% dark pool, 50% lit. Example: 5K order → 100% lit (fast execution), 25K order → 7.5K dark, 17.5K lit, 100K order → 50K dark, 50K lit. Why threshold? Dark pools have lower fill rates (20-40%), not worth latency for small orders. Large orders benefit from stealth (avoid front-running). **Dark Pool Allocation Percentage**: Formula: dark_pct = min(0.30 + (quantity - 10000)/100000 × 0.20, 0.50). Breakdown: Base: 30% for 10K order, Increases: +0.20% per additional 1K shares, Cap: 50% maximum. Examples: 10K order: 30% dark (3K), 40K order: 30% + 30×0.20% = 36% dark (14.4K), 100K order: 50% dark (50K, capped). Reasoning: Start conservative (30%), increase for larger orders (more impact), never exceed 50% (need execution certainty). **Dark Pool Selection Criteria**: Criterion 1: Historical fill rate (most important): Liquidnet: 35% (institutional focus), ITG POSIT: 30% (cross network), CS CrossFinder: 25% (broker pool). Choose pools with >25% fill rate. Criterion 2: Price improvement: Most dark pools execute at midpoint, NBBO: $150.00 bid, $150.01 ask, Midpoint: $150.005, Savings: 0.5 cents vs taker on lit venue. Expected improvement: 0.5 cents × fill_rate (30%) = 0.15 cents per share. Criterion 3: Pool size/liquidity: Larger pools (more participants) → higher fill probability. Liquidnet: $50B+ AUM, broker pools: varies. Criterion 4: Information leakage: Avoid pools with toxic flow (HFT, predatory), prefer institutional-only pools. Selection: Rank pools by fill rate × price improvement, allocate to top 3 pools equally. **Timeout Strategy**: Rule: Wait maximum 5 seconds for dark pool response. Timeline: T+0s: Send IOI (Indication of Interest) to dark pools, T+0-5s: Wait for potential matches, T+5s: Cancel unfilled portions, route to lit venues. Why 5 seconds? Dark pools need time to find counterparty, longer wait = opportunity cost (price moves), 5s balances fill opportunity vs urgency. Adaptive timeout: Volatile market: 3s (prices moving fast), Calm market: 10s (more time to find liquidity). **Fallback to Lit Venues**: Trigger 1: Timeout (5 seconds elapsed): Action: Cancel dark pool orders, route unfilled to lit NBBO. Trigger 2: Partial fill threshold: If dark fill <20% after 3 seconds → route rest to lit. Example: Send 30K to dark pools, after 3s, filled 4K (13%) → route remaining 26K to lit. Trigger 3: Market move: If NBBO moves 0.1% against order → immediately route to lit. Example: Buying, NBBO ask moves from $150.01 to $150.16 (+0.1%) → dark pools won\'t fill at old price, route to lit at new NBBO. Fallback execution: Use smart routing for lit portion (split across venues), prioritize speed (market orders) over rebates. **Performance Measurement**: Metric 1: Fill rate: Dark pool: 30% filled (expected), Lit venue: 98% filled. Combined: (30K dark × 30%) + (70K lit × 98%) = 9K + 68.6K = 77.6K / 100K = 77.6% (decent). Metric 2: Average price: Dark fills: 9K @ $150.005 (midpoint) = $1,350,045, Lit fills: 68.6K @ $150.01 (NBBO ask) = $10,290,686, Lit fills: 22.4K @ $150.02 (next level) = $3,360,448, Total: 100K @ $150.0114 weighted avg. Metric 3: Price improvement: Dark: Saved (150.01 - 150.005) × 9K = $45, Lit NBBO: No improvement, Lit next: Lost (150.02 - 150.01) × 22.4K = $224, Net: $45 - $224 = -$179 (slight loss). But: Saved market impact (hidden 30K shares), Avoided signaling (stealth value). Metric 4: Total cost: Dark: $0 fees × 9K = $0, Lit taker: $0.003 × 90.6K = $272, Total fees: $272, Slippage: $0.0114 - $150.01 = $0.0014 → 140 bps (!), Wait, that\'s wrong: (150.0114 - 150.01)/150.01 × 10000 = 0.93 bps, Total cost: Fees $272 + slippage $140 = $412 → 2.75 bps. Comparison to All-Lit: All lit: 100K @ $150.013 (more impact), Fees: $300, Total: 3.5 bps. Dark + Lit: 2.75 bps → Saved 0.75 bps = $112. **Implementation**: class DarkPoolRouter: def route_order(symbol, side, quantity, limit_price): if quantity < 10000: return route_to_lit(symbol, side, quantity), # Calculate allocation, dark_pct = calculate_dark_allocation(quantity), dark_qty = int(quantity × dark_pct), lit_qty = quantity - dark_qty, # Send to dark pools with timeout, dark_fills = await send_to_dark_pools_with_timeout(symbol, side, dark_qty, timeout=5), # Route unfilled to lit, unfilled = dark_qty - sum(dark_fills), lit_fills = await route_to_lit(symbol, side, lit_qty + unfilled), return combine_fills(dark_fills, lit_fills).',
        keyPoints: [
            'Threshold: Use dark pools for orders >10K shares; 30% allocation at 10K, scaling to 50% at 100K+ shares',
            'Selection: Choose pools with >25% fill rate, midpoint execution (0.5 cent savings), low information leakage',
            'Timeout: Wait max 5 seconds for dark fills; cancel and route to lit if <20% filled after 3 seconds',
            'Fallback: Immediately route to lit if NBBO moves >0.1% or timeout expires; use smart routing for lit portion',
            'Performance: Dark pool saves 0.75 bps vs all-lit (2.75 vs 3.5 bps) through price improvement and stealth value',
        ],
    },
];

