import { MultipleChoiceQuestion } from '@/lib/types';

export const marketMicrostructureFundamentalsMultipleChoice: MultipleChoiceQuestion[] = [
    {
        id: 'mmf-mc-1',
        question:
            'In a price-time priority matching engine, you submit a limit buy order for 500 shares at $100.00. The order book shows 300 shares already at $100.00 (submitted 1 second ago) and 400 shares at $99.99. A market sell order for 600 shares arrives. How many shares will you get filled?',
        options: [
            '300 shares (the remaining after the first order at $100.00 fills)',
            '500 shares (your entire order)',
            '200 shares (pro-rata allocation)',
            '0 shares (no fill, orders ahead of you)',
        ],
        correctAnswer: 0,
        explanation:
            'Price-time priority: 300 shares filled (remaining at $100.00 after earlier order). Matching logic: Market sell order: 600 shares to sell at best available price. Order book bid side: $100.00: 300 shares (Time: T-1 second, first in queue), $100.00: 500 shares (Your order, T=0, second in queue), $99.99: 400 shares. Matching sequence: Price priority: $100.00 is best bid (highest price), Time priority: Within $100.00, first-come-first-served (FIFO). Execution: Step 1: Market sell fills 300 shares @ $100.00 (first order in queue, time priority). Remaining: 600 - 300 = 300 shares to sell. Step 2: Market sell fills 300 shares @ $100.00 (your order, second in queue). Your fill: 300 out of 500 (partial fill). Remaining: Your order has 200 shares resting at $100.00 (still in book). Step 3: Market sell fully filled (600 shares executed). Result: First order: Fully filled (300/300). Your order: Partially filled (300/500). Third order: No fill (market order consumed first two). Why not 500 shares? Your full order would require: 300 (first order) + 500 (your order) = 800 shares. Market sell order: Only 600 shares available. Math: Not enough to fill you completely. Price-time priority: Earlier order at same price goes first (you\'re second). Why not pro-rata (200 shares)? Pro-rata: Used by some futures exchanges, not price-time priority. Calculation: 500 / (300 + 500) = 62.5% of available. Your fill: 62.5% × 600 = 375 shares (if pro-rata). Actual: Price-time priority (FIFO), not pro-rata. Why not 0 shares? 0 fill: Would mean orders ahead consumed entire sell order. Reality: 300 shares ahead, 600 available → 300 remaining for you. First order: Takes 300, you get next 300. Queue position matters: If you were third in queue (behind two 300-share orders), you\'d get 0 (600 - 300 - 300 = 0). Practical implications: Queue position: Critical in price-time priority. HFT racing: Speed matters (get to front of queue). First-in advantage: Earlier orders fill first (all else equal). Modifications lose priority: Cancel-replace → back of queue (new timestamp). Order book state after: Bid side: $100.00: 200 shares (your remaining), $99.99: 400 shares. Ask side: Unchanged (no new orders). Your next fill: Must wait for next market sell or aggressive limit sell. Alternative scenario - Pro-rata: If exchange used pro-rata matching: First order: 300 / 800 = 37.5% of pool → 37.5% × 600 = 225 shares. Your order: 500 / 800 = 62.5% of pool → 62.5% × 600 = 375 shares. Total: 225 + 375 = 600 (all allocated). Comparison: Price-time: 300 you, 300 first order. Pro-rata: 375 you, 225 first order. Advantage: Pro-rata favors larger orders (your 500 > their 300). Real-world examples: NASDAQ: Price-time priority (you get 300). NYSE: Price-time priority (you get 300). CME (some products): Pro-rata (you\'d get 375). Options exchanges: Often pro-rata. Key lesson: Know your exchange\'s matching algorithm. Price-time: Speed and timing critical (race to front of queue). Pro-rata: Size matters more (larger orders get more fills).',
    },
    {
        id: 'mmf-mc-2',
        question:
            'An IOC (Immediate-or-Cancel) order to buy 1,000 shares at $50.00 is submitted when the order book shows asks at $50.00 (400 shares), $50.01 (300 shares), and $50.02 (500 shares). What happens?',
        options: [
            '400 shares filled at $50.00, remaining 600 shares cancelled',
            '1,000 shares filled (walking the book to $50.01 and $50.02)',
            'Entire order cancelled (not enough at $50.00)',
            '400 shares filled, 600 shares converted to limit order at $50.00',
        ],
        correctAnswer: 0,
        explanation:
            'IOC order: 400 filled at limit price, 600 cancelled (unfilled portion). IOC logic: Definition: Immediate-or-Cancel (execute immediately, cancel rest). Behavior: Matches whatever liquidity available at or better than limit price. No resting: Never added to order book (unlike regular limit orders). Partial fills: Acceptable (unlike FOK which requires all-or-nothing). Order details: Type: IOC buy, Limit price: $50.00, Quantity: 1,000 shares. Order book: Ask $50.00: 400 shares (matches limit price ≤ $50.00), Ask $50.01: 300 shares (exceeds limit price), Ask $50.02: 500 shares (exceeds limit price). Matching: Price check: Ask $50.00 ≤ limit $50.00 → Match (acceptable price). Quantity: 400 shares available at $50.00. Execution: Buy 400 @ $50.00 (fills immediately). Remaining: 1,000 - 400 = 600 shares. Next price level: $50.01 > $50.00 limit → Stop (price too high). IOC rule: Can\'t match at worse than limit price. Result: Fill 400 shares @ $50.00, Cancel 600 shares (unfilled). Why not walk the book to $50.01/$50.02? Limit price: $50.00 (maximum willing to pay). $50.01 and $50.02: Above limit (too expensive). Limit order: Protects from paying more than specified. IOC doesn\'t override: Still respects limit price (won\'t pay $50.01 even to fill). Market order difference: Market order: Would walk the book (pay any price to fill). Would buy: 400 @ $50.00, 300 @ $50.01, 300 @ $50.02 (total 1,000 shares). No limit: Price uncertainty (could pay much higher). Why not entire order cancelled? FOK (Fill-or-Kill): All-or-nothing, would cancel entire order. IOC: Partial fills allowed (400 is valid fill even if < 1,000). Difference: FOK: Requires 1,000 at $50.00 or cancel. IOC: Fills whatever available (400 is okay). Why not convert to limit order? IOC rule: Unfilled portion is cancelled (not converted). Limit order: Remains in book until filled or cancelled. IOC: Never rests in book (immediate action only). Use case: Testing liquidity (don\'t want to leave footprint if no liquidity). Practical example: Scenario: HFT testing order book depth. Strategy: Send IOC to see how much liquidity at specific price. Result: 400 filled → now know "at least 400 shares available". Information: No leakage (didn\'t leave order in book for others to see). Regular limit: Would show 600 shares resting → others see intent. Order book after execution: Asks: $50.01: 300 shares (unchanged), $50.02: 500 shares (unchanged). Bids: Possibly your 600-share cancel creates no impact (never in book). Your position: Long 400 shares @ $50.00 (partial fill). Unfilled: 600 shares (opportunity cost if price rises). Comparison of order types: Market order (1,000 shares): Fills 400 @ $50.00, 300 @ $50.01, 300 @ $50.02. Total: 1,000 shares, VWAP = $50.0067. Certainty: 100% filled. Price: Uncertain (walked to $50.02). Limit order (1,000 @ $50.00): Fills 400 @ $50.00 immediately. Rests: 600 shares in book at $50.00 (waits for sellers). Certainty: 400 filled now, 600 uncertain (may never fill). IOC (1,000 @ $50.00): Fills 400 @ $50.00 immediately. Cancels: 600 shares (no resting). Certainty: 400 filled (40% fill rate). FOK (1,000 @ $50.00): Fills: Nothing (not enough at $50.00). Cancels: Entire 1,000 shares (all-or-nothing). Certainty: 0% filled (strict requirement). When to use IOC: Testing liquidity: Want to know available depth without committing. Avoiding adverse selection: Don\'t want to sit in book (others can see and react). Speed: Need to know immediately if liquidity exists. No commitment: Don\'t want to rest order (could be filled later when don\'t want). Real-world: HFT strategies: IOC is primary order type (speed and information). Market makers: Test liquidity before quoting. Arbitrageurs: Need exact quantity for spread (use IOC to test).',
    },
    {
        id: 'mmf-mc-3',
        question:
            'A market maker is long 1,000 shares of AAPL (accumulated inventory) and wants to reduce this position. Using the Avellaneda-Stoikov inventory adjustment model with risk aversion γ=0.001, current mid-price is $150.00. What should the market maker do with their quotes?',
        options: [
            'Shift quotes downward: Lower bid and ask to incentivize selling (e.g., bid $149.95, ask $150.00)',
            'Shift quotes upward: Raise bid and ask to incentivize buying',
            'Widen the spread symmetrically: Bid $149.95, ask $150.05',
            'Stop quoting the ask side entirely',
        ],
        correctAnswer: 0,
        explanation:
            'Avellaneda-Stoikov: Lower quotes when long (shift downward). Inventory management problem: Current position: Long 1,000 shares (accumulated). Goal: Reduce inventory (sell shares, return to neutral). Challenge: Can\'t just market sell (market impact, adverse selection). Solution: Adjust quotes to incentivize selling over buying. Avellaneda-Stoikov model: Reservation price: r = S - γ × q. Where: S = current mid-price ($150.00), γ = risk aversion parameter (0.001), q = inventory position (+1000 shares, long). Calculation: r = $150.00 - 0.001 × 1000 = $150.00 - $1.00 = $149.00. Quote generation: Bid = r - spread/2, Ask = r + spread/2. Assume spread = $0.10 (example): Bid = $149.00 - $0.05 = $148.95, Ask = $149.00 + $0.05 = $149.05. Effect: Shift downward by $1.00 (inventory adjustment). Comparison to neutral: Neutral inventory (q = 0): r = $150.00 - 0.001 × 0 = $150.00. Quotes: Bid $149.95, Ask $150.05 (centered around mid). Long inventory (q = +1000): r = $149.00 (lower reservation price). Quotes: Bid $148.95, Ask $149.05 (shifted down $1.00). Incentive structure: Bid (buy): $148.95 (lower than neutral). Effect: Less likely to buy (less aggressive). Less accumulation: Reduces probability of increasing position. Ask (sell): $149.05 (lower than neutral). Effect: More likely to sell (more aggressive, better price for buyers). Faster offload: Increases probability of reducing position. Result: Asymmetry favors selling (what we want when long). Why not shift upward? Long position: Need to sell (not buy more). Shifting up: Bid $150.95, Ask $151.05. Effect: More likely to buy (higher bid, more aggressive). Worse: Would accumulate more inventory (opposite of goal). Ask higher: Less likely to sell (worse price for buyers). Incorrect: When long, want to sell (not buy). Why not widen spread symmetrically? Widen to $149.95 / $150.05: Bid stays same, ask raised. Effect on bid: No change in buy incentive. Effect on ask: Less likely to sell (worse price). Wrong direction: Want to incentivize selling (lower ask, not raise). Symmetric widening: Doesn\'t address inventory problem. Use case: Reduce risk (when uncertain), not offload inventory. Why not stop quoting ask? Stop quoting ask: Only quote bid (buy side). Problem: Can only accumulate more (buy), not sell. Opposite: Want to sell, not buy (we\'re already long). Stopping bid: Would make more sense (don\'t accumulate more). But also stop providing liquidity: Lose spread capture opportunity. Mathematical intuition: Reservation price: Price at which indifferent to buying or selling. Long inventory: Lower reservation price (inventory risk). Value inventory less: Would sell at lower price (eager to offload). Risk aversion: Higher γ → larger adjustment (more aggressive offload). Example: γ = 0.01: Adjustment = 0.01 × 1000 = $10.00 (very aggressive shift). γ = 0.0001: Adjustment = 0.0001 × 1000 = $0.10 (gentle shift). Real-world application: Market maker scenario: Bought 1000 shares throughout day (accumulated). End of day approaching: Want to flatten position (avoid overnight risk). Strategy: Lower quotes (incentivize selling). Speed: Inventory offloaded faster (quotes more attractive to buyers). Alternative actions: Aggressive offload: Remove bid entirely (only quote ask), Lower ask even more (e.g., ask = $149.00, at bid of market). Risk: Adverse selection (only sell if price about to drop further). Emergency: If near close, market sell remaining (accept slippage). Expected outcome: Ask fills faster: Lower price attracts buyers (filled more frequently). Bid fills slower: Lower bid less attractive to sellers (filled less). Net: Inventory reduced (long → neutral). PnL: Small cost (sold slightly below mid), but reduced risk (worth it). Numerical example: Without adjustment (neutral): Bid $149.95, Ask $150.05 (spread $0.10). Assumption: 50% probability bid fills, 50% probability ask fills (balanced). Result: Inventory unchanged (buy and sell equal). With adjustment (long 1000): Bid $148.95, Ask $149.05. Probability: 30% bid fills (less likely, worse price), 70% ask fills (more likely, better price). Result: Net selling (reducing inventory). Expected inventory change: Buy: 0.3 × size = +30 shares. Sell: 0.7 × size = -70 shares. Net: -40 shares per period (reducing long position). Time to neutral: 1000 shares / 40 per period = 25 periods. Key intuition: Long inventory: Lower quotes (shift down). Short inventory: Raise quotes (shift up). Magnitude: Proportional to γ × q (risk aversion × position). Market making balance: Provide liquidity (earn spread) while managing inventory risk. Avellaneda-Stoikov: Optimal framework (provably optimal under certain assumptions).',
    },
    {
        id: 'mmf-mc-4',
        question:
            'Reg NMS (Order Protection Rule) requires that a broker cannot execute a trade at a price worse than the National Best Bid or Offer (NBBO) on protected quotations. NASDAQ shows ask at $50.00 (500 shares), NYSE shows ask at $50.01 (1,000 shares). Your client submits a market buy order for 800 shares. What must the broker do to comply with Reg NMS?',
        options: [
            'Route 500 shares to NASDAQ at $50.00, then 300 shares to NYSE at $50.01',
            'Route all 800 shares to NYSE at $50.01 (largest liquidity pool)',
            'Execute at the average price of $50.005 (500 at $50.00 + 300 at $50.01)',
            'Route all 800 shares to NASDAQ (even though only 500 available there)',
        ],
        correctAnswer: 0,
        explanation:
            'Reg NMS compliance: Route to best price first (NASDAQ $50.00), then next best. Order Protection Rule (Rule 611): Requirement: Cannot trade through protected quotes (better prices elsewhere). Protected quote: Automated, displayed quote on registered exchange (NASDAQ, NYSE are protected). Trade-through: Executing at worse price when better price available elsewhere. Example: Buying at $50.01 (NYSE) when $50.00 (NASDAQ) available = trade-through (prohibited). Order details: Type: Market buy (price uncertainty, quantity certainty). Quantity: 800 shares. NBBO: National Best Bid and Offer. Best ask: $50.00 (NASDAQ, 500 shares). Second-best ask: $50.01 (NYSE, 1,000 shares). Routing logic: Step 1: Route to best price (NASDAQ $50.00). Available: 500 shares. Route: 500 shares to NASDAQ @ $50.00. Remaining: 800 - 500 = 300 shares. Step 2: Route to next-best price (NYSE $50.01). Available: 1,000 shares (more than enough). Route: 300 shares to NYSE @ $50.01. Remaining: 0 (fully filled). Execution summary: NASDAQ: 500 shares @ $50.00 = $25,000. NYSE: 300 shares @ $50.01 = $15,003. Total: 800 shares @ VWAP = $40,003 / 800 = $50.00375. Compliance: No trade-through (accessed best price first). Why not route all to NYSE? NYSE advantage: Deeper liquidity (1,000 vs 500 shares), Single venue (simpler routing). Problem: Price $50.01 > NASDAQ $50.00 (worse price). Trade-through: Would buy at $50.01 when $50.00 available elsewhere. Violation: Reg NMS prohibits trading through protected quotes. Penalty: Broker could be fined, client could sue for damages. Cost: 800 × ($50.01 - $50.00) = 800 × $0.01 = $8 (not huge, but illegal). Why not average price $50.005? Execution reality: Trades execute at specific prices (not averages). NASDAQ: 500 @ $50.00 (actual trade), NYSE: 300 @ $50.01 (actual trade). Average: $50.00375 (VWAP, post-trade calculation). Not a routing decision: Can\'t tell exchange "execute at average price". Execution venue: Each venue reports actual trade price. Why not all to NASDAQ? NASDAQ liquidity: Only 500 shares available (order book depth). Order: 800 shares required. Shortfall: 800 - 500 = 300 shares unfilled at NASDAQ. Must route elsewhere: Next-best price (NYSE $50.01) for remaining 300. Alternative: Could wait for more liquidity at $50.00 (but market order demands immediate execution). Order Protection Rule nuances: Protected quotes: Automated: Immediately accessible electronically (not manual). Displayed: Visible to all market participants (not dark pool). Registered exchange: NASDAQ, NYSE, BATS, etc. (not OTC). Exception - Intermarket Sweep Order (ISO): Definition: Order explicitly routed to take through protected quotes. Requirement: Simultaneously send orders to protect quotes. Example: Send 500 to NASDAQ @ $50.00, simultaneously 800 to NYSE @ $50.01. Result: NASDAQ fills 500, NYSE fills 300 (remaining after NASDAQ). Legal: Protected NASDAQ quote (even though NYSE filled at worse price). Broker responsibility: Best execution: Fiduciary duty to get best price for client. Routing: Must access NBBO before worse prices (Reg NMS). Monitoring: Real-time NBBO tracking (direct feeds, not SIP). Smart Order Router (SOR): Automates compliance (routes to best prices first). Historical context: Pre-Reg NMS: Brokers could route to preferred venue (e.g., payment for order flow). Result: Customers got worse prices (broker earned kickback). Reg NMS (2007): Order protection (must access best prices), transparency (display NBBO publicly), fair access (can\'t discriminate). Impact: Tighter spreads, better execution, more complex routing. Real-world scenario: Broker receives market buy: 800 shares. SOR queries all venues: NASDAQ $50.00 (500), NYSE $50.01 (1000), BATS $50.02 (200). Decision: (1) 500 to NASDAQ $50.00 (best price, protected), (2) 300 to NYSE $50.01 (next best, protected). Alternative: Dark pools could provide price improvement. Example: Dark pool at $49.99 (better than NBBO). Legal: Route to dark pool first (saves client money). But: Dark pools often illiquid (may not fill). Execution report: Venue breakdown: NASDAQ: 500 @ $50.00, NYSE: 300 @ $50.01. Client sees: Total 800 @ avg $50.00375. Compliance: Reg NMS satisfied (no trade-through). Key lessons: Reg NMS: Protects customers from worse prices. Routing: Multi-venue (access best prices across all exchanges). Best execution: Legal requirement (fiduciary duty). Technology: Requires fast market data and smart routing (microsecond decisions).',
    },
    {
        id: 'mmf-mc-5',
        question:
            'A stop-loss sell order at $99.00 is placed when the stock is trading at $100.00. The stock drops to $98.50 in a single trade (gap down). What happens to the stop order?',
        options: [
            'Triggers at $99.00, converts to market order, likely fills around $98.50 (slippage)',
            'Fills at exactly $99.00 (stop price guaranteed)',
            'Cancels (price gapped past stop, order invalid)',
            'Converts to limit order at $99.00, remains unfilled',
        ],
        correctAnswer: 0,
        explanation:
            'Stop order: Triggers at $99, becomes market order, fills at $98.50 (slippage). Stop order mechanics: Definition: Conditional order that becomes active when stop price hit. Stop-loss sell: Trigger: Price drops to or below stop price ($99.00). Action: Convert to market sell order (sell immediately at best available price). Purpose: Limit losses on long position (exit before further decline). Initial state: Position: Long stock (own shares). Current price: $100.00 (above stop price). Stop order: Sell @ $99.00 stop (dormant, waiting to trigger). Market event: Sharp drop: Price falls from $100.00 to $98.50 in single trade. Cause: Large sell order, bad news, liquidity vacuum. Gap down: No trades between $100 and $98.50 (skipped over $99). Stop trigger: Condition check: Price $98.50 ≤ stop $99.00 → triggered. Conversion: Stop order becomes market sell order immediately. No guaranteed price: Stop price ($99) is trigger, not execution price. Market order: Sell at best available bid (whatever it is now). Execution: Market sell: Execute immediately at current best bid. Best bid: Likely around $98.50 (after gap down). Fill price: $98.50 (not $99.00). Slippage: $99.00 - $98.50 = $0.50 per share (50 cents worse than expected). Example: 100 shares: Expected loss: ($100 - $99) × 100 = $100 (if filled at stop). Actual loss: ($100 - $98.50) × 100 = $150. Extra loss: $50 due to slippage (50% more than expected). Why not fill at exactly $99.00? Stop price: Trigger level (activates order), not limit price (execution constraint). Market order: No price protection (executes at any available price). Gap down: Price jumped from $100 to $98.50 (no trades at $99). No liquidity: No one willing to buy at $99 after gap (all bids pulled). Best bid: $98.50 (that\'s where market clears). Result: Fill at $98.50 (current market price, not stop price). Why not cancel? Stop order behavior: Triggered = active (doesn\'t disappear). Market order: Must execute (exchange matches at available price). No cancellation: Stop order became market order (follows through to execution). Gap past stop: Doesn\'t invalidate order (just triggers at worse price). Alternative: Stop-limit order would cancel if price gaps past limit (but that\'s different type). Why not convert to limit at $99? Stop order: Becomes market order (by definition). Market order: No price limit (executes at any price). Not a stop-limit: Stop-limit would place limit order at $99 (protection). This order: Plain stop (no limit component). Result: Market order fills at $98.50 (best available). Stop-limit order comparison: Stop-limit sell @ $99.00: Trigger: Price $99 → activate limit sell @ $99. Gap to $98.50: Limit order placed @ $99 (no execution, price below limit). Remains unfilled: Sitting at $99, waiting for price to return. Risk: Price continues down (never fills, bigger loss). Trade-off: Stop: Guarantees exit (market order), but uncertain price (slippage risk). Stop-limit: Guarantees minimum price ($99 limit), but uncertain execution (may not fill). Real-world scenarios: Normal decline: Price: $100 → $99.50 → $99.00 (stop triggers). Fill: $98.95 (small slippage, market order walks the book). Acceptable: Small slippage (few cents). Flash crash: Price: $100 → $99 (trigger) → $95 (gap down). Fill: $95 (huge slippage). Problem: Stop orders exacerbate decline (forced selling creates more selling). Example: Flash Crash 2010 (many stop losses triggered, cascading selling). Liquidity vacuum: Price: $100 → $99 (trigger) → no bids (liquidity disappears). Fill: $90 (first available bid, way below stop). Disaster: 10% loss when expected 1% loss. Rare: But possible in illiquid stocks or market stress. Mitigation strategies: Stop-limit: Place limit at $98.50 (accept non-fill risk for price protection). Wider stop: Place at $95 (less likely to trigger on noise). Mental stop: Monitor manually, decide based on context (not automatic). No stop: Accept full downside risk (not suitable for risk management). Options: Buy protective put (insurance, guaranteed downside protection). Practical example: Position: Long 1,000 shares @ $100 (cost basis $100,000). Stop: Sell @ $99 stop (limit loss to $1,000). Gap down: Price drops to $98.50. Fill: 1,000 shares @ $98.50 = $98,500. Loss: $100,000 - $98,500 = $1,500. Slippage: $1,500 - $1,000 = $500 (50% more loss than planned). Percentage: Expected loss: 1%, Actual loss: 1.5%, Slippage: 0.5%. Exchange mechanics: Stop monitoring: Exchange monitors last trade price (or bid price, exchange-dependent). Trigger: Price $98.50 ≤ stop $99.00 → triggers. Conversion: Stop order removed from stop order book, added to order book as market sell. Matching: Market sell matched against current bids (best bid $98.50). Execution: Filled @ $98.50 (trade reported). Key lessons: Stop orders: Protect from unlimited loss (exit mechanism). Not guaranteed price: Stop price is trigger, not fill price. Slippage: Especially in gaps, fast moves, illiquid stocks. Stop-limit: Alternative for price protection (but execution risk). Risk management: Stops are tool, not perfect solution (understand limitations).',
    },
];

